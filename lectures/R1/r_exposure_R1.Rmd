---
title: "CSSS508, Week 1"
subtitle: "RStudio and RMarkdown"
author: "Chuck Lanfear"
date: "Sep 25, 2019<br>Updated: `r gsub(' 0', ' ', format(Sys.Date(), format='%b %d, %Y'))`"
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: xaringan-themer.css
    nature:
      highlightStyle: tomorrow-night-bright
      highlightLines: true
      countIncrementalSlides: false
      titleSlideClass: ["center","top"]
---

```{r setup, include=FALSE, purl=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(comment = "##")
```

# Course Goals

* Develop intermediate data management and analysis skills in R

--

* Learn basic programming

--

* Introduce reproducible research practices

--

* Prepare you for statistics and CSSS courses

---
# Who is this guy?

**Chuck Lanfear**

* Instructor (*not professor*)

--

* 6th Year Sociology PhD student

--

* Research:
--

  + Quantitative Sociology
--

  + Computational Social Science
--

  + Experimental Criminology
  
--

* Translation:
--

  + I write code every day
--

  + I am a turbo-nerd 
--

  + I think programming is incredibly important

---
# Logistics

Location: 
* Lecture: SAV 117 on Wednesdays, 3:30-5:20
* Recommended Lab: SAV 117 on Mondays, 3:30-5:20
   * Note: Limited capacity!
* Office Hours: SAV 255 by Appointment

Materials: http://clanfear.github.io/CSSS508

Grading:
* Final grade: C/NC, 60% to get Credit
* **Homework** most weeks (75% of grade), combination of reading and programming
* **Peer Grading** of homeworks (25% of grade)
* Both handed in via Canvas.

---

# Peer grading, really?

--

Yes, peer grading...
--

* **60+ students, no TA**
--

* You will write your reports better knowing others will see them
--

* Learn new tricks from reading others' code; "appreciate the little things"
--


### Format:

* Randomly assigned peers, turnaround time: 1 week (due before next class)
* You'll get a rubric and are expected to leave constructive comments
* High scoring assignments may be adapted into keys (with your permission)
* **Email me** if you want more feedback

---

# Materials

All course materials are on the course website. This includes:

* These slides and the code used to generate them.
* An R script for the slides to follow along in class.
* PDFs of slides if you like those.
* Homework templates (HW 4+).
* Video recordings of *last term's* lectures.
* Useful links to other resources.

If you find something on the website doesn't work, please Slack or email me.

---

# Lab

Lab is optional but strongly recommended. They are interactive and are not recorded.

--

### Labs 1-3

I will provide general technical support and answer any R related questions you have, whether for the
homework or not.

--

### Labs 4+

In the latter two-thirds of the course, we will *walk through homeworks together*. 
This provides students a guided walk through the more complex homeworks.

This gives students the option of (1) working independently on homeworks for maximum
learning, (2) reserving homeworks for lab if they are too challenging or time consuming, or
(3) a bit of both.

---

# Using the Mailing List

Don't ask like this:

> tried lm(y~x) but it iddn't work wat do

--

Instead, ask like this: 

<blockquote>
<pre>
y <- seq(1:10) + rnorm(10)
x <- seq(0:10)
model <- lm(y ~ x)
</pre>

Running the block above gives me the following error, anyone know why?

<pre>
Error in model.frame.default(formula = y ~ x, 
drop.unused.levels = TRUE) : variable lengths differ 
(found for 'x')
</pre>
</blockquote>

.footnote[Try to use fixed-width font for code in emails.]

---

# Slack Channel

This course uses a [Slack Channel](https://uwcsss508.slack.com/) for additional communication.

You will receive a link to join via the email list.

Use it like the mailing list to ask questions, particularly for *short questions*.

Use the mailing list for *long questions* or those requiring you to attach a file.

In addition, I encourage you to use Slack *during class* to ask quick questions
of other students and share links.

Don't be afraid to answer each others' questions!

---

# A Note on Slide Formatting

**Bold** usually indicates an important vocabulary term. Remember these!

--

*Italics* indicate emphasis but also are used to point out things you must click with a mouse, for example: "Please click *File > Print*"

--

`Code` represents R code you type into the editor or console or keystrokes used to perform actions, for example: "Press `Ctrl-P` to open the print dialogue."

--

Code chunks that span the page represent *actual R code embedded in the slides*.

```{r}
# Sometimes important stuff is highlighted! #<<
7 * 49
```

The lines preceded by `##` represent the output, or result, of running the code in the code chunk. We'll talk about this more later!

---

# Lecture Plan

1. Intro to R, RStudio, and R Markdown
--

2. Plotting with `ggplot2`
--

3. Summarizing and Combining Data: `dplyr`
--

4. R Data Structures
--

5. Data Cleaning: Import/Export, `tidyr`, Dates
--

6. Loops and Functions
--

7. Vectorization and Functions
--

8. Strings / Text Processing
--

9. Geospatial Data and Maps*
10. Working with Model Results*
11. Reproducibility and Applied Data Cleaning*

.footnote[[\*] We will do *one* of these!]

--

If you miss any lecture or want to see a lecture not offered this term, recordings are available on the course website.


---
class: inverse

# R and RStudio


---

# Why R?

R is a programming language built for statistical computing.

If one already knows Stata or similar software, why use R?
--

* R is *free*, so you don't need a terminal server.
--

* R has a *very* large community.
--

* R can handle virtually any data format.
--

* R makes replication easy.
--

* R is a *language* so it can do *everything*.
--

* R is a good stepping stone to other languages like Python.

---

# R Studio

R Studio is a "front-end" or integrated development environment (IDE) for R that can make your life *easier*.

--

RStudio can:
--

* Organize your code, output, and plots.
--

* Auto-complete code and highlight syntax.
--

* Help view data and objects.
--

* Enable easy integration of R code into documents.

---

# Selling you on R Markdown

A killer feature of R/RStudio is ease of making R Markdown files:
--

* Document analysis as you go with integrated text, code, and output

--

  + No rerunning, recopying, or repasting
--

  + Easy for collaborators to understand
--

  + Show as little or as much of the code as you want
  
--

* Produce many different document types as output

--

  + PDF documents
  + HTML webpages and reports
  + Word and PowerPoint documents  
  + Presentations (like these slides)

--

* Works with LaTeX for math and more formatting control

--

We'll get back to this shortly!

---

# Getting Started

Open up RStudio now and choose *File > New File > R Script*.

Then, let's get oriented with the interface:

* *Top Left*: Code **editor** pane, data viewer (browse with tabs)

* *Bottom Left*: **Console** for running code (`>` prompt)

* *Top Right*: List of objects in **environment**, code **history** tab.

* *Bottom Right*: Tabs for browsing files, viewing plots, managing packages, and viewing help files.

You can change the layout in *Preferences > Pane Layout*

---

# Editing and Running Code

There are several ways to run R code in RStudio:
--

* Highlight lines in the **editor** window and click *Run* at the top or hit `Ctrl+Enter` or `⌘+Enter` to run them all.

--

* With your **caret** on a line you want to run, hit `Ctrl+Enter` or `⌘+Enter`. Note your caret moves to the next line, so you can run code sequentially with repeated presses.

--

* Type individual lines in the **console** and press `Enter`.

--

* In R Markdown documents, click within a code chunk and click the green arrow to run the chunk. The button beside that runs *all prior chunks*.

--

The console will show the lines you ran followed by any printed output.

---

# Incomplete Code

If you mess up (e.g. leave off a parenthesis), R might show a `+` sign prompting you to finish the command:

```{r Coding 1, eval=FALSE}
> (11-2
+
```

Finish the command or hit `Esc` to get out of this.

---

# R as a Calculator

In the **console**, type `123 + 456 + 789` and hit `Enter`.
--

```{r Calc 1}
123 + 456 + 789
```

--

The `[1]` in the output indicates the numeric **index** of the first element on that line.

--

Now in your blank R document in the **editor**, try typing the line `sqrt(400)` and either
clicking *Run* or hitting `Ctrl+Enter` or `⌘+Enter`.

--

```{r Calc 2}
sqrt(400)
```

---

# Functions and Help

`sqrt()` is an example of a **function** in R.

If we didn't have a good guess as to what `sqrt()` will do, we can type `?sqrt` in the console
and look at the **Help** panel on the right.

```{r Help, eval=FALSE}
?sqrt
```

**Arguments** are the *inputs* to a function. In this case, the only argument to `sqrt()`
is `x` which can be a number or a vector of numbers.

Help files provide documentation on how to use functions and what functions produce.

---

# Creating Objects

R stores everything as an **object**, including data, functions, models, and output.

--

Creating an object can be done using the **assignment operator**: `<-` 
--

```{r Objects 1}
new.object <- 144
```

--

**Operators** like `<-` are functions that look like symbols but typically sit between their arguments 
(e.g. numbers or objects) instead of having them inside `()` like in `sqrt(x)`<sup>1</sup>. 

.footnote[[1] We can actually call operators like other functions by stuffing them between backticks: <code  class="r">``` \`+\`(x,y) ```</code>]

--

We do math with operators, e.g., `x + y`. `+` is the addition operator!

---

# Calling Objects

You can display or "call" an object simply by using its name.

```{r Objects 2}
new.object
```

--

Object names can contain `_` and `.` in them but cannot *begin* with numbers. Try
to be consistent in naming objects. RStudio auto-complete means *long names are better 
than vague ones*! 

*Good names save confusion later.<sup>1</sup>*

.footnote[[1] "There are only two hard things in Computer Science: cache invalidation and naming things." - Phil Karlton]

---

# Using Objects

An object's **name** represents the information stored in that **object**, so you can treat the object's name
as if it were the values stored inside.
--

```{r Objects 3}
new.object + 10
new.object + new.object
sqrt(new.object)
```

---

# Creating Vectors

A **vector** is a series of **elements**, such as numbers.

--

You can create a vector and store it as an object in the same way. To do this, use the
function `c()` which stands for "combine" or "concatenate".
--

```{r Vectors 1}
new.object <- c(4, 9, 16, 25, 36)
new.object
```

--

If you name an object the same name as an existing object, *it will overwrite it*.

--

You can provide a vector as an argument for many functions.
--

```{r Vectors 2}
sqrt(new.object)
```

---

# More Complex Objects

The same principles can be used to create more complex objects like **matrices**, **arrays**, **lists**, and **dataframes** (lists which look like matrices but can hold multiple data types at once).

Most data sets you will work with will be read into R and stored as a **dataframe**, so this course will mainly focus on manipulating and visualizing these objects.

Before we get into these, let's revisit R Markdown.

---
class: inverse

# R Markdown

---

# R Markdown Documents

Let's try making an R Markdown file:

1. Choose *File > New File > R Markdown...*
2. Make sure *HTML Output* is selected and click OK
3. Save the file somewhere, call it `my_first_rmd.Rmd`
4. Click the *Knit HTML* button
5. Watch the progress in the R Markdown pane, then gaze upon your result!

You may also open up the file in your computer's browser if you so desire, using the *Open in Browser* button at the top of the preview window.

---

# R Markdown Headers

The header of an .Rmd file is a [YAML](http://yaml.org/) (YAML Ain't Markup Language<sup>1</sup>) code block, and everything else is part of the main document.

.footnote[[1] Nerds love recursive acronyms.
 ]
--

```{}
---
title: "Untitled"
author: "Charles Lanfear"
date: "March 28, 2018"
output: html_document
---
```
--

To mess with global formatting, [you can modify the header](http://rmarkdown.rstudio.com/html_document_format.html)<sup>2</sup>.

.footnote[[2] Be careful though, YAML is space-sensitive; indents matter!]

```{}
output:
  html_document:
    theme: readable
```



---
# R Markdown Syntax
.pull-left[

## Output

**bold/strong emphasis**

*italic/normal emphasis*

# Header
## Subheader
### Subsubheader

> Block quote from
> famous person
]

.pull-right[
## Syntax

<pre>
**bold/strong emphasis**

*italic/normal emphasis*


# Header


## Subheader

### Subsubheader

> Block quote from
> famous person
</pre>
]

---

# More R Markdown Syntax

.pull-left[
## Output

1. Ordered lists
1. Are real easy
  1. Even with sublists
  1. Or when lazy with numbering
  
* Unordered lists
* Are also real easy
  + Also even with sublists

[URLs are trivial](http://www.uw.edu)

![pictures too](http://depts.washington.edu/uwcreate/img/UW_W-Logo_smallRGB.gif)
]

.pull-right[

## Syntax

<pre>
1. Ordered lists
1. Are real easy
  1. Even with sublists
  1. Or when lazy with numbering


* Unordered lists
* Are also real easy
  + Also even with sublists

[URLs are trivial](http://www.uw.edu)

![pictures too](http://depts.washington.edu/uwcreate/img/UW_W-Logo_smallRGB.gif)
</pre>
]

---

# Formulae and Syntax

.pull-left[
## Output 

You can put some math $y= \left( \frac{2}{3} \right)^2$ right up in there.

$$\frac{1}{n} \sum_{i=1}^{n} x_i = \bar{x}_n$$

Or a sentence with `code-looking font`.


Or a block of code:

<pre>
y <- 1:5
z <- y^2
<pre>
]

.pull-right[

## Syntax

<pre>
You can put some math $y= \left(
\frac{2}{3} \right)^2$ right up in 
there

$$\frac{1}{n} \sum_{i=1}^{n}
x_i = \bar{x}_n$$

Or a sentence with `code-looking font`.

Or a block of code:

    ```
    y <- 1:5
    z <- y^2
    ```
</pre>
]

---

# R Markdown Tinkering

R Markdown docs can be modified in many ways. Visit these links for more information.

* [Ways to modify the overall document appearance](http://rmarkdown.rstudio.com/html_document_format.html)
* [Ways to format parts of your document](http://rmarkdown.rstudio.com/authoring_basics.html)
* [R Markdown: The Definitive Guide](https://bookdown.org/yihui/rmarkdown/)

---

# Formatting Caveats

To keep R Markdown dead-simple, it lacks some features you might occasionally want to use. Your options for fancier documents are:

* Templates
* Use HTML with CSS for custom formatting<sup>1</sup>
* Use LaTeX and .Rnw files instead of .Rmd<sup>2</sup>

For day-to-day use, plain vanilla R Markdown does the job.

For handouts, memos, and homeworks, default R Markdown PDFs look surprisingly good!


.footnote[
[1] These slides were created using [Xaringan](https://github.com/yihui/xaringan), a blend of RMarkdown and CSS.

[2] Here be dragons! LaTeX is powerful but exacts a terrible price.
]

---

# R Code in R Markdown

Inside RMarkdown, lines of R code are called **chunks**. Code is sandwiched between sets of three backticks and `{r}`. This chunk of code...

    ```{r}`r ''`
    summary(cars)
    ```

Produces this output in your document:
```{r}
summary(cars)
```

---


# Chunk Options

Chunks have options that control what happens with their code, such as:

* `echo=FALSE`: Keeps R code from being shown in the document

* `eval=FALSE`: Shows R code in the document without running it

* `include=FALSE`: Hides all output but still runs code (good for `setup` chunks where you load packages!)

* `results='hide'`: Hides R's (non-plot) output from the document

* `cache=TRUE`: Saves results of running that chunk so if it takes a while, you won't have to re-run it each time you re-knit the document

* `fig.height=5, fig.width=5`: modify the dimensions of any plots that are generated in the chunk (units are in inches)


Some of these can be modified using the gear-shaped *Modify Chunk Options* button in each chunk. [There are a *lot* of other options, however](https://yihui.name/knitr/options/).

---

# Playing with Chunk Options

Try adding or changing the chunk options (separated by commas) for the two chunks in `my_first_Rmd.Rmd` and re-knitting to check what happens.


You can also name your chunks by putting something after the `r` before the chunk options.

    ```{r summarize_cars, echo=FALSE}`r ''`
    summary(cars)
    ```
After you name your chunks, look what happens in the dropdown on the bottom left of your editor pane.

Naming chunks allows you to browse through an RMarkdown document by named chunks. 

You can also browse by sections named using headers and subheaders.

---

# In-Line R code

Sometimes we want to insert a value directly into our text. We do that using code in single backticks starting off with `r`.
--

```{r, echo=FALSE}
library(knitr)
```


    Four score and seven years ago is the same as `r inline_expr("4*20 + 7", "md")` years.
--
Four score and seven years ago is the same as `r 4*20 + 7` years.

--

Maybe we've saved a variable in a chunk we want to reference in the text:

```{r}
x <- sqrt(77) # <- is how we assign variables
```
--

    The value of `x` rounded to the nearest two decimals is `r inline_expr("round(x, 2)", "md")`.
--
The value of `x` rounded to the nearest two decimals is `r round(x, 2)`.

---

# This is Amazing!

Having R dump values directly into your document protects you from silly mistakes:

--

* Never wonder "how did I come up with this quantity?" ever again: Just look at your formula in your .Rmd file!

--

* Consistency! No "find/replace" mishaps; reference a variable in-line throughout your document without manually updating if the calculation changes (e.g. reporting sample sizes).

--

* You are more likely to make a typo in a "hard-coded" number than you are to write R code that somehow runs but gives you the wrong thing.

---

# Example: Keeping Dates

In your YAML header, make the date come from R's `Sys.time()` function by changing:

    date: "March 30, 2016"
to:

    date: "`r inline_expr("Sys.time()", "md")`"
Fancier option: Use this instead to take today's date and make it read nicely:<sup>1</sup>

    date: "`r inline_expr("format(Sys.Date(), format='%B %d, %Y')", "md")`"

.footnote[[1] `format(Sys.Date(), format='%B %d, %Y')` says "format system date as month name (`%B`), day-of-month (`%d`), and four-digit year (`%Y`): `r format(Sys.Date(), format='%B %d, %Y')`. See `?strptime` for these format codes.]
---
class: inverse

# Data Frames

---

# What's Up with `cars`?

In the sample R Markdown document you are working on, we can load the built-in data
`cars`, which loads as a dataframe, a type of object mentioned earlier. Then, we can look at it in a couple different ways.

--

`data(cars)` loads this dataframe into the **Global Environment** (as a *promise*<sup>1</sup>).

.pull-right[.footnote[[1] Promises are *unevaluated arguments*. Read more about R's [lazy evaluation here](http://adv-r.had.co.nz/Functions.html).]]

--

`View(cars)` pops up a **Viewer** pane ("interactive" use only, don't put in R Markdown document!) or...
--

```{r}
head(cars, 5) # prints first 5 rows, see tail() too
```



---

# Tell Me More About `cars`

`str()` displays the structure of an object:
```{r}
str(cars) # str[ucture]
```

--

`summary()` displays summary information<sup>1</sup>:
```{r}
summary(cars)
```

.pull-right[.footnote[[1] [Note R is **object-oriented**](https://adv-r.hadley.nz/oo.html): `summary()` provides different information for different types of objects!]]

---

# Ugly Pictures of `cars`

`hist()` generates a histogram of a vector. Note you can access a vector that is a column of a dataframe using `$`, the **extract operator**.

.pull-left[
```{r, out.height="330px"}
hist(cars$speed) # Histogram
```
]

.pull-right[
```{r, out.height="330px"}
hist(cars$dist)
```
]

---

## Drawing Slightly Less Ugly Pictures


```{r, out.height="400px"}
hist(cars$dist,
     xlab = "Distance (ft)", # X axis label
     main = "Observed stopping distances of cars") # Title
```


---

# Math with `cars`

If you put an assignment such as `x <- y` in parentheses `()`, R will print the output of the assignment out for you in your document. Otherwise, it won't show the value.
--

```{r}
( dist_mean  <- mean(cars$dist) )
( speed_mean <- mean(cars$speed) )
```

---

# Drawing Still Ugly Pictures

.small[
```{r, out.height="330px"}
plot(dist ~ speed, data = cars, #<<
     xlab = "Speed (mph)",
     ylab = "Stopping distance (ft)",
     main = "Speeds and stopping distances of cars",
     pch = 16) # Point size
abline(h = dist_mean, col = "firebrick")
abline(v = speed_mean, col = "cornflowerblue")
```
]

.pull-right[
.footnote[Note that `dist ~ speed` is a **formula** of the type `y ~ x`. The first element (`dist`) gets plotted on the y-axis and the second (`speed`) goes on the x-axis. Regression formulae follow this convention as well!]
]

---

# `swiss` Time

Let's switch gears to the `swiss` data frame built in to R.

--

First, use `?swiss` to see what things mean.

--

Then, load it using `data(swiss)`

--

Add chunks to your R Markdown document inspecting swiss, defining variables, doing some exploratory plots using hist or plot.

You might experiment with [colors](http://www.stat.columbia.edu/~tzheng/files/Rcolor.pdf) and [shapes](http://www.cookbook-r.com/Graphs/Shapes_and_line_types/).

---

## Looking at `swiss`

```{r, out.height="340px"}
pairs(swiss, pch = 8, col = "violet", #<<
      main = "Pairwise comparisons of Swiss variables")
```

.pull-right30[
.footnote[`pairs()` is a pairwise scatterplot function. Good for a quick look at small datasets, but mostly useless for larger data.]
]

---

# Installing Packages

Let's make a table that looks a little less code-y in the output. To do this, we'll 
want to install a **package** called `pander`. Packages contain premade functions 
and/or data we can use. R's strength is its wide variety of packages!

In the console: `install.packages("pander")`.

--

* Note that unlike the `library()` command, *the name of a package to be installed must be in quotes*. This is because the name here is a search term (text, not an object!) while for `library()` it is an actual R object.

--

* Once you install a package, you don't need to re-install it until you update R. *Consequently, you should not include* `install.packages()` *in any markdown document or R script!*

---

# Making Tables

```{r, eval=FALSE}
library(pander) # loads pander, do once in your session
pander(summary(swiss), style = "rmarkdown", split.tables = 120) #<<
```

.small[
```{r, echo=FALSE}
library(pander) # loads pander, do once in your session
pander(summary(swiss), style = "rmarkdown", split.tables = 120)
```
]

.footnote[Note that we put the `summary(swiss)` function call inside the `pander()` call. This is called *nesting functions* and is very common. I'll introduce a method next week to avoid confusion from nesting too many functions inside each other.]

---

## Data Look a Little Nicer This Way

```{r, eval=FALSE}
pander(head(swiss, 5), style = "rmarkdown", split.tables = 120)
```
.small[
```{r, echo=FALSE}
pander(head(swiss, 5), style = "rmarkdown", split.tables = 120)
```
]

.footnote[`split.tables = 120` tells `pander` to break a table into multiple tables if it will be over 120 characters wide. Adjust this to get widths *just right*.]
---
class: inverse

# Homework

Write up a .Rmd file showing some exploratory analyses of the Swiss fertility data. Upload both the `.Rmd` file and the `.html` file to Canvas. You must upload *both* for credit.

Mix in-line R calculations, tables, R output, and plots with text describing the relationships you see. Include *at least* one plot and one table. You are encouraged to include more! You must use in-line R calculations/references at least once (e.g. functions like `nrow()`, `mean()`, `sd()`, `cor()`, `median()`, `min()`) and *may not hard-code any numbers referenced in your text*.

Your document should be pleasant for a peer to look at, with some organization using sections or lists, and all plots labeled clearly. Use chunk options `echo` and `results` to limit the code/output you show in the .html. Discussion of specific values should be summarized in sentences in your text---*not as printed code and output*---and rounded so as not to be absurdly precise (e.g. round `x` with `round(x, 2)`).

### DUE: 11:59 PM, Tuesday, October 1st, 2019

---

# Grading Rubric

0 - Didn't turn anything in.

--

1 - Turned in but low effort, ignoring many directions.

--

2 - Decent effort, followed directions with some minor issues.

--

3 - Nailed it!


# But First...
## *Some useful stuff*

---

# Comments

You may have noticed that sometimes I have written code that looks like this:
```{r}
new.object <- 1:10 # Making vector of 1 to 10 
```
`#` is known as the *commenting symbol* in R!

Anything written on the same line *after* `#` will not be run by R.

This is useful for annotating your code to remind you (or others) what you are doing in a section.<sup>1</sup>

.footnote[
[1] In R Markdown documents, comments only work in chunks. Outside of a chunk, `#` creates **headers** like "comments" at the top of this slide.
]

---

# Saving Files

You can save an R object on your computer as a file to open later:
```{r}
save(new.object, file="new_object.RData")
```

--

You can open saved files in R as well:
```{r}
load("new_object.RData")
```

--

But where are these files being saved and loaded from?

---

# Working Directories

R saves files and looks for files to open in your current **working directory**<sup>1</sup>. You
can ask R what this is:

.footnote[[1] For a simple R function to open an Explorer / Finder window at your working directory, [see this StackOverflow response](https://stackoverflow.com/a/12135823/10277284).]

```{r}
getwd()
```

--

Similarly, we can set a working directory like so:

```{r, eval=FALSE}
setwd("C:/Users/cclan/Documents")
```

--

*Don't set a working directory in R Markdown documents!* They automatically set the directory they are in as the working directory.

---

# Managing Files

When managing R projects, it is normally best to give each project (such as a homework
assignment) its own folder. I use the following system:

--

* Every class or project has its own folder
--

* Each assignment or task has a folder inside that, which is the working directory for that item.
--

* `.Rmd` and `.R` files are named clearly and completely

--

For example, this presentation is located and named this:
`GitHub/CSSS508/Lectures/Week2/CSSS508_Week2_ggplot2.Rmd`

--

You can use whatever system you want, but be consistent so your projects are organized! 
You don't want to lose work by losing or overwriting files!

--

For large projects containing many files, I recommend using RStudio's built in project management system found in the top right of the RStudio window.

--

For journal articles I recommend Ben Marwick's [`rrtools`](https://github.com/benmarwick/rrtools) and [`huskydown`](https://github.com/benmarwick/huskydown) for UW dissertations and theses. [I made an `rrtools` demo presentation here](https://clanfear.github.io/birthtiming/inst/presentation/presentation.html#/).

---

# File Types

We mainly work with three types of file in this class:

--

* `.Rmd`: These are **markdown** *syntax* files, where you write code to *make documents*.

--

* `.R`: These are **R** *syntax* files, where you write code to process and analyze data *without making an output document*.<sup>1</sup>

.footnote[[1] While beyond the scope of this class, you can use the `source()` function to run a `.R` script file inside a `.Rmd` or `.R` file. Using this you can break a large project up into multiple files but still run it all at once!]

--

* `.html` or `.pdf`: These are the output documents created when you *knit* a markdown document.

--

Make sure you understand the difference between the uses of these file types! Please
ask for clarification if needed!

---
class: inverse

# Data and Subsetting

---

# Gapminder Data

We'll be working with data from Hans Rosling's [Gapminder](http://www.gapminder.org) project.
An excerpt of these data can be accessed through an R package called `gapminder`, cleaned and assembled by Jenny Bryan at UBC.

--

In the console: `install.packages("gapminder")`

Load the package and data:
```{r}
library(gapminder)
```

---

# Check Out Gapminder

The data frame we will work with is called `gapminder`, available once you have loaded the package. Let's see its structure:

.small[
```{r}
str(gapminder)
```
]

---

# What's Interesting Here?

* **Factor** variables `country` and `continent`

   + Factors are categorical data with an underlying numeric representation
   + We'll spend a lot of time on factors later!

--

* Many observations: $n=`r nrow(gapminder)`$ rows

--

* A nested/hierarchical structure: `year` in `country` in `continent`

   + These are panel data!

---
class: inverse

# Subsetting Data


---

# Installing Tidyverse

We'll want to be able to slice up this data frame into subsets (e.g. just the rows for Afghanistan, just the rows for 1997).

We will use a package called `dplyr` to do this neatly.

`dplyr` is part of the [tidyverse](http://tidyverse.org/) family of R packages that are the focus of this course.

--

If you have not already installed the tidyverse, type, in the console: `install.packages("tidyverse")`

--

This will install a *large* number of R packages we will use throughout the term, including `dplyr`.

`dplyr` is a very useful and powerful package that we will talk more about soon, but today we're just going to use it for "filtering" data.

---

# Loading dplyr

```{r, message=TRUE}
library(dplyr)
```

---

# Wait, was that an error?

When you load packages in R that have functions sharing the same name as functions you already have, the more recently loaded functions overwrite the previous ones ("masks them").

--

This **message** is just letting you know that. To avoid showing this in your R Markdown file, add `message=FALSE` or `include=FALSE` to your chunk options when loading packages.

--

Sometimes you may get a **warning message** when loading packages---usually because you aren't running the latest version of R:

```
Warning message:
package `gapminder' was built under R version 3.5.3 
```
Chunk options `message=FALSE` or `include=FALSE` will hide this. *Update R* to deal with it completely!

---

# `magrittr` and Pipes

`dplyr` allows us to use `magrittr`<sup>1</sup> operators (`%>%`) to "pipe" data between functions. So instead of nesting functions like this:

.footnote[[1] [Ceci n'est pas un pipe](https://en.wikipedia.org/wiki/The_Treachery_of_Images)]

```{r}
log(mean(gapminder$pop))
```

--

We can pipe them like this:

```{r}
gapminder$pop %>% mean() %>% log()
```

--

Read this as, "send `gapminder$pop` to `mean()`, then send the output of that to `log()`."
In essence, pipes read "left to right" while nested functions read "inside to out."
This may be confusing... we'll cover it more later!

---

# `filter` Data Frames

```{r}
gapminder %>% filter(country == "Oman")
```

What is this doing?

---

# Logical Operators

We used `==` for testing "equals": `country == "Oman"`.

--

There are many other [logical operators](http://www.statmethods.net/management/operators.html):

--

* `!=`: not equal to
--

* `>`, `>=`, `<`, `<=`: less than, less than or equal to, etc.
--

* `%in%`: used with checking equal to one of several values

--

Or we can combine multiple logical conditions:

* `&`: both conditions need to hold (AND)
--

* `|`: at least one condition needs to hold (OR)
--

* `!`: inverts a logical condition (`TRUE` becomes `FALSE`, `FALSE` becomes `TRUE`)

--

We'll use these a lot so don't worry too much right now!

---

# Multiple Conditions Example

Let's say we want observations from Oman after 1980 and through 2000.

--

```{r}
gapminder %>%
    filter(country == "Oman" &
           year > 1980 &
           year <= 2000 )
```

---

# Saving a Subset

If we think a particular subset will be used repeatedly, we can save it and give it a name like any other object:

```{r}
China <- gapminder %>% filter(country == "China")
head(China, 4)
```

---
class: inverse

# `ggplot2`

.center[
<img src="https://github.com/clanfear/CSSS508/raw/master/Lectures/Week2/img/ggplot2unit.jpg" style="width: 60%;"/>
]

---

## Base R Plots from Last Week

.pull-left[
 .small[
```{r, eval=FALSE}
plot(lifeExp ~ year, 
     data = China, 
     xlab = "Year", 
     ylab = "Life expectancy",
     main = "Life expectancy in China", 
     col = "red", 
     cex.lab = 1.5,
     cex.main= 1.5,
     pch = 16)
```
 ]
]

.pull-right[
```{r, echo=FALSE}
plot(lifeExp ~ year, data = China, xlab = "Year", ylab = "Life expectancy",
     main = "Life expectancy in China", col = "red", cex = 1, pch = 16)
```
]

---
# `ggplot2`

An alternative way of plotting many prefer (myself included)<sup>1</sup> uses the `ggplot2` package in R, which is part of the `tidyverse`.

.footnote[[1] [Though this is not without debate](http://simplystatistics.org/2016/02/11/why-i-dont-use-ggplot2/)]

```{r}
library(ggplot2)
```

The core idea underlying this package is the [**layered grammar of graphics**](https://doi.org/10.1198/jcgs.2009.07098): we can break up elements of a plot into pieces and combine them.

---
## Chinese Life Expectancy in `ggplot`

.pull-left[
 .small[
```{r,  dev='svg', eval=FALSE}
ggplot(data = China, 
       aes(x = year, y = lifeExp)) +
    geom_point()
```
]
]

.pull-right[
```{r,  dev='svg', echo=FALSE}
ggplot(data = China, aes(x = year, y = lifeExp)) +
    geom_point()
```
]

---
# Structure of a ggplot

`ggplot2` graphics objects consist of two primary components:

--

1. **Layers**, the components of a graph.

   * We *add* layers to a `ggplot2` object using `+`.
   * This includes lines, shapes, and text.

--

2. **Aesthetics**, which determine how the layers appear.

   * We *set* aesthetics using *arguments* (e.g. `color="red"`) inside layer functions.
   * This includes locations, colors, and sizes.
   * Aesthetics also determine how data *map* to appearances.

---

# Layers

**Layers** are the components of the graph, such as:

* `ggplot()`: initializes `ggplot2` object, specifies input data
* `geom_point()`: layer of scatterplot points
* `geom_line()`: layer of lines
* `ggtitle()`, `xlab()`, `ylab()`: layers of labels
* `facet_wrap()`: layer creating separate panels stratified by some factor wrapping around
* `facet_grid()`: same idea, but can split by two variables along rows and columns (e.g. `facet_grid(gender ~ age_group)`)
* `theme_bw()`: replace default gray background with black-and-white

Layers are separated by a `+` sign. For clarity, I usually put each layer on a new line, unless it takes few or no arguments (e.g. `xlab()`, `ylab()`, `theme_bw()`).

---

# Aesthetics

**Aesthetics** control the appearance of the layers:

* `x`, `y`: $x$ and $y$ coordinate values to use
* `color`: set color of elements based on some data value
* `group`: describe which points are conceptually grouped together for the plot (often used with lines)
* `size`: set size of points/lines based on some data value
* `alpha`: set transparency based on some data value

---

## Aesthetics: Setting vs. mapping

Layers take arguments to control their appearance, such as point/line colors or transparency (`alpha` between 0 and 1).

--

* Arguments like `color`, `size`, `linetype`, `shape`, `fill`, and `alpha` can be used directly on the layers (**setting aesthetics**), e.g. `geom_point(color = "red")`. See the [`ggplot2` documentation](http://docs.ggplot2.org/current/vignettes/ggplot2-specs.html) for options. These *don't depend on the data*.

--

* Arguments inside `aes()` (**mapping aesthetics**) will *depend on the data*, e.g. `geom_point(aes(color = continent))`.

--

* `aes()` in the `ggplot()` layer gives overall aesthetics to use in other layers, but can be changed on individual layers (including switching `x` or `y` to different variables)

--

This may seem pedantic, but precise language makes searching for help easier.

--

Now let's see all this jargon in action.

---
## Axis Labels, Points, No Background

### 1: Base Plot

.pull-left[
 .small[
```{r, fig.height=4, dev='svg', eval=FALSE}
ggplot(data = China,  #<<
       aes(x = year, y = lifeExp)) #<<
```
]
]
.pull-right[
```{r, dev='svg', echo=FALSE}
ggplot(data = China,  
       aes(x = year, y = lifeExp)) 
```
]

.footnote[We initialize the plot with `ggplot()` and an aesthetic.]

---


## Axis Labels, Points, No Background

### 2: Scatterplot

.pull-left[
 .small[
```{r, fig.height=4, dev='svg', eval=FALSE}
ggplot(data = China, 
       aes(x = year, y = lifeExp)) +
  geom_point() #<<
```
]
]
.pull-right[
```{r,  dev='svg', echo=FALSE}
ggplot(data = China, 
       aes(x = year, y = lifeExp)) +
  geom_point() 
```
]

.footnote[Add a scatterplot.]
---


## Axis Labels, Points, No Background

### 3: Point Color and Size

.pull-left[
 .small[
```{r, fig.height=4, dev='svg', eval=FALSE}
ggplot(data = China, 
       aes(x = year, y = lifeExp)) +
  geom_point(color = "red", size = 3) #<<
```
]
]
.pull-right[
```{r,  dev='svg', echo=FALSE}
ggplot(data = China, 
       aes(x = year, y = lifeExp)) +
  geom_point(color = "red", size = 3) 
```
]

.footnote[Make the points large and red.]
---


## Axis Labels, Points, No Background

### 4: X-Axis Label

.pull-left[
 .small[
```{r, fig.height=4, dev='svg', eval=FALSE}
ggplot(data = China, 
       aes(x = year, y = lifeExp)) +
  geom_point(color = "red", size = 3) +
  xlab("Year") #<<
```
]
]
.pull-right[
```{r,  dev='svg', echo=FALSE}
ggplot(data = China, 
       aes(x = year, y = lifeExp)) +
  geom_point(color = "red", size = 3) +
  xlab("Year") 
```
]

.footnote[Capitalize the x-axis label.]
---


## Axis Labels, Points, No Background

### 5: Y-Axis Label

.pull-left[
 .small[
```{r, fig.height=4, dev='svg', eval=FALSE}
ggplot(data = China, 
       aes(x = year, y = lifeExp)) +
  geom_point(color = "red", size = 3) +
  xlab("Year") + 
  ylab("Life expectancy") #<<
```
]
]
.pull-right[
```{r,  dev='svg', echo=FALSE}
ggplot(data = China, 
       aes(x = year, y = lifeExp)) +
  geom_point(color = "red", size = 3) +
  xlab("Year") + 
  ylab("Life expectancy")
```
]

.footnote[Clean up the y-axis label.]
---


## Axis Labels, Points, No Background

### 6: Title

.pull-left[
 .small[
```{r, fig.height=4, dev='svg', eval=FALSE}
ggplot(data = China, 
       aes(x = year, y = lifeExp)) +
  geom_point(color = "red", size = 3) +
  xlab("Year") + 
  ylab("Life expectancy") +
  ggtitle("Life expectancy in China") #<<
```
]
]
.pull-right[
```{r,  dev='svg', echo=FALSE}
ggplot(data = China, 
       aes(x = year, y = lifeExp)) +
  geom_point(color = "red", size = 3) +
  xlab("Year") + 
  ylab("Life expectancy") +
  ggtitle("Life expectancy in China")
```
]

.footnote[Add a title.]
---


## Axis Labels, Points, No Background

### 7: Theme

.pull-left[
 .small[
```{r, fig.height=4, dev='svg', eval=FALSE}
ggplot(data = China, 
       aes(x = year, y = lifeExp)) +
  geom_point(color = "red", size = 3) +
  xlab("Year") + 
  ylab("Life expectancy") +
  ggtitle("Life expectancy in China") +
  theme_bw() #<<
```
]
]
.pull-right[
```{r,  dev='svg', echo=FALSE}
ggplot(data = China, 
       aes(x = year, y = lifeExp)) +
  geom_point(color = "red", size = 3) +
  xlab("Year") + 
  ylab("Life expectancy") +
  ggtitle("Life expectancy in China") +
  theme_bw() #<<
```
]

.footnote[Pick a nicer theme.]
---


## Axis Labels, Points, No Background

### 8: Text Size

.pull-left[
 .small[
```{r, fig.height=4, dev='svg', eval=FALSE}
ggplot(data = China, 
       aes(x = year, y = lifeExp)) +
  geom_point(color = "red", size = 3) +
  xlab("Year") + 
  ylab("Life expectancy") +
  ggtitle("Life expectancy in China") +
  theme_bw(base_size=18) #<<
```
]
]
.pull-right[
```{r,  dev='svg', echo=FALSE}
ggplot(data = China, 
       aes(x = year, y = lifeExp)) +
  geom_point(color = "red", size = 3) +
  xlab("Year") + 
  ylab("Life expectancy") +
  ggtitle("Life expectancy in China") +
  theme_bw(base_size=18) #<<
```
]

.footnote[Increase the base text size.]
---
# Plotting All Countries

We have a plot we like for China... 

... but what if we want *all the countries*?

---


# Plotting All Countries

### 1: A Mess!
.pull-left[
 .small[
```{r, fig.height=4, dev='svg', eval=FALSE}
ggplot(data = gapminder,#<<
       aes(x = year, y = lifeExp)) +
  geom_point(color = "red", size = 3) +
  xlab("Year") + 
  ylab("Life expectancy") +
  ggtitle("Life expectancy over time") +
  theme_bw(base_size=18)
```
]
]
.pull-right[
```{r,  dev='svg', echo=FALSE}
ggplot(data = gapminder, #<<
       aes(x = year, y = lifeExp)) +
  geom_point(color = "red", size = 3) +
  xlab("Year") + 
  ylab("Life expectancy") +
  ggtitle("Life expectancy over time") +
  theme_bw(base_size=18)
```
]

.footnote[We can't tell countries apart! Maybe we could follow *lines*?]

---


# Plotting All Countries

### 2: Lines
.pull-left[
 .small[
```{r, fig.height=4, dev='svg', eval=FALSE}
ggplot(data = gapminder, 
       aes(x = year, y = lifeExp)) +
  geom_line(color = "red", size = 3) + #<<
  xlab("Year") + 
  ylab("Life expectancy") +
  ggtitle("Life expectancy over time") +
  theme_bw(base_size=18)
```
]
]
.pull-right[
```{r,  dev='svg', echo=FALSE}
ggplot(data = gapminder, 
       aes(x = year, y = lifeExp)) +
  geom_line(color = "red", size = 3) + #<<
  xlab("Year") + 
  ylab("Life expectancy") +
  ggtitle("Life expectancy over time") +
  theme_bw(base_size=18)
```
]

.footnote[`ggplot2` doesn't know how to connect the lines!]

---


# Plotting All Countries

### 3: Grouping
.pull-left[
 .small[
```{r, fig.height=4, dev='svg', eval=FALSE}
ggplot(data = gapminder, 
       aes(x = year, y = lifeExp, 
           group = country)) + #<<
  geom_line(color = "red", size = 3) +
  xlab("Year") + 
  ylab("Life expectancy") +
  ggtitle("Life expectancy over time") +
  theme_bw(base_size=18)
```
]
]
.pull-right[
```{r,  dev='svg', echo=FALSE}
ggplot(data = gapminder, 
       aes(x = year, y = lifeExp, 
           group = country)) + #<<
  geom_line(color = "red", size = 3) +
  xlab("Year") + 
  ylab("Life expectancy") +
  ggtitle("Life expectancy over time") +
  theme_bw(base_size=18)
```
]

.footnote[That looks more reasonable... but the lines are too thick!]
---


# Plotting All Countries

### 4: Size
.pull-left[
 .small[
```{r, fig.height=4, dev='svg', eval=FALSE}
ggplot(data = gapminder, 
       aes(x = year, y = lifeExp, 
           group = country)) +
  geom_line(color = "red") + #<<
  xlab("Year") + 
  ylab("Life expectancy") +
  ggtitle("Life expectancy over time") +
  theme_bw(base_size=18)
```
]
]
.pull-right[
```{r,  dev='svg', echo=FALSE}
ggplot(data = gapminder, 
       aes(x = year, y = lifeExp, 
           group = country)) +
  geom_line(color = "red") + #<<
  xlab("Year") + 
  ylab("Life expectancy") +
  ggtitle("Life expectancy over time") +
  theme_bw(base_size=18)
```
]

.footnote[Much better... but maybe we can do highlight regional differences?]

---


# Plotting All Countries

### 5: Color
.pull-left[
 .small[
```{r, fig.height=4, dev='svg', eval=FALSE}
ggplot(data = gapminder, 
       aes(x = year, y = lifeExp, 
           group = country, 
           color = continent)) + #<<
  geom_line() + #<<
  xlab("Year") + 
  ylab("Life expectancy") +
  ggtitle("Life expectancy over time") +
  theme_bw(base_size=18)
```
]
]
.pull-right[
```{r,  dev='svg', echo=FALSE}
ggplot(data = gapminder, 
       aes(x = year, y = lifeExp, 
           group = country, 
           color = continent)) + #<<
  geom_line() + #<<
  xlab("Year") + 
  ylab("Life expectancy") +
  ggtitle("Life expectancy over time") +
  theme_bw(base_size=18) #<<
```
]

.footnote[Patterns are obvious... but why not separate continents completely?]

---


# Plotting All Countries

### 6: Facets
.pull-left[
 .small[
```{r, fig.height=4, dev='svg', eval=FALSE}
ggplot(data = gapminder, 
       aes(x = year, y = lifeExp, 
           group = country, 
           color = continent)) +
  geom_line() +
  xlab("Year") + 
  ylab("Life expectancy") +
  ggtitle("Life expectancy over time") +
  theme_bw(base_size=18) + 
  facet_wrap(~ continent) #<<
```
]
]
.pull-right[
```{r,  dev='svg', echo=FALSE}
ggplot(data = gapminder, 
       aes(x = year, y = lifeExp, 
           group = country, 
           color = continent)) +
  geom_line() +
  xlab("Year") + 
  ylab("Life expectancy") +
  ggtitle("Life expectancy over time") +
  theme_bw(base_size=18) +
  facet_wrap(~ continent) #<<
```
]

.footnote[Now the text is too big!]
---


# Plotting All Countries

### 7: Text Size
.pull-left[
 .small[
```{r, fig.height=4, dev='svg', eval=FALSE}
ggplot(data = gapminder, 
       aes(x = year, y = lifeExp, 
           group = country, 
           color = continent)) +
  geom_line() +
  xlab("Year") + 
  ylab("Life expectancy") +
  ggtitle("Life expectancy over time") +
  theme_bw() +  #<<
  facet_wrap(~ continent)
```
]
]
.pull-right[
```{r,  dev='svg', echo=FALSE}
ggplot(data = gapminder, 
       aes(x = year, y = lifeExp, 
           group = country, 
           color = continent)) +
  geom_line() +
  xlab("Year") + 
  ylab("Life expectancy") +
  ggtitle("Life expectancy over time") +
  theme_bw() + #<<
  facet_wrap(~ continent)
```
]

.footnote[Better, but could bring that legend in.]

---


# Plotting All Countries

### 8: Legend Position
.pull-left[
 .small[
```{r, fig.height=4, dev='svg', eval=FALSE}
ggplot(data = gapminder, 
       aes(x = year, y = lifeExp, 
           group = country, 
           color = continent)) +
  geom_line() +
  xlab("Year") + 
  ylab("Life expectancy") +
  ggtitle("Life expectancy over time") +
  theme_bw() +  
  facet_wrap(~ continent) +
  theme(legend.position = c(0.8, 0.25)) #<<
```
]
]
.pull-right[
```{r,  dev='svg', echo=FALSE}
ggplot(data = gapminder, 
       aes(x = year, y = lifeExp, 
           group = country, 
           color = continent)) +
  geom_line() +
  xlab("Year") + 
  ylab("Life expectancy") +
  ggtitle("Life expectancy over time") +
  theme_bw() + 
  facet_wrap(~ continent) +
  theme(legend.position = c(0.8, 0.25)) #<<
```
]

.footnote[Better... but do we even need it?]
---


# Plotting All Countries

### 9: No Legend
.pull-left[
 .small[
```{r, fig.height=4, dev='svg', eval=FALSE}
ggplot(data = gapminder, 
       aes(x = year, y = lifeExp, 
           group = country, 
           color = continent)) +
  geom_line() +
  xlab("Year") + 
  ylab("Life expectancy") +
  ggtitle("Life expectancy over time") +
  theme_bw() +  
  facet_wrap(~ continent) +
  theme(legend.position = "none") #<<
```
]
]
.pull-right[
```{r,  dev='svg', echo=FALSE}
ggplot(data = gapminder, 
       aes(x = year, y = lifeExp, 
           group = country, 
           color = continent)) +
  geom_line() +
  xlab("Year") + 
  ylab("Life expectancy") +
  ggtitle("Life expectancy over time") +
  theme_bw() + 
  facet_wrap(~ continent) +
  theme(legend.position = "none") #<<
```
]

.footnote[Looking good!]

---

# Storing Plots

We can assign a `ggplot` object to a name:

```{r}
lifeExp_by_year <- 
  ggplot(data = gapminder, 
       aes(x = year, y = lifeExp, 
           group = country, 
           color = continent)) +
  geom_line() +
  xlab("Year") + 
  ylab("Life expectancy") +
  ggtitle("Life expectancy over time") +
  theme_bw() + 
  facet_wrap(~ continent) +
  theme(legend.position = "none")
```

The graph won't be displayed when you do this. You can show the graph using a single line of code with just the object name, *or take the object and add more layers*.

---

# Showing a Stored Graph

```{r, fig.height=4, dev='svg'}
lifeExp_by_year
```

---

## Adding a Layer

```{r, fig.height=4, dev='svg'}
lifeExp_by_year +
    theme(legend.position = "bottom")
```


---

## Common Problem: Overplotting

Often we want a scatterplot of things that have discrete units. All those dots plot over each other!

.small[
```{r, fig.height=4, dev='svg'}
ggplot(data = gapminder, aes(x = continent, y = year, color = continent)) +
    geom_point()
```
]
---

## Fixing Overplotting with Jitter

Inside `geom_point()`, `position = position_jitter(width=a, height=b)` shifts points up to `a` units horizontally and `b` units vertically.

.small[
```{r, fig.height=4, dev='svg'}
ggplot(data = gapminder, aes(x = continent, y = year, color = continent)) +
    geom_point(position = position_jitter(width = 0.5, height = 2)) #<<
```
]
---

# Changing the Axes

We can modify the axes in a variety of ways, such as:

* Change the $x$ or $y$ range using `xlim()` or `ylim()` layers

* Change to a logarithmic or square-root scale on either axis: `scale_x_log10()`, `scale_y_sqrt()`

* Change where the major/minor breaks are: `scale_x_continuous(breaks =, minor_breaks = )`

---

# Axis Changes

```{r, fig.height=3.5, dev='svg'}
ggplot(data = China, aes(x = year, y = gdpPercap)) +
    geom_line() +
    scale_y_log10(breaks = c(1000, 2000, 3000, 4000, 5000), #<<
                  labels = scales::dollar) + #<<
    xlim(1940, 2010) + ggtitle("Chinese GDP per capita")
```

---

# Fonts Too Small?

```{r, fig.height=3.5, dev='svg'}
ggplot(data = China, aes(x = year, y = lifeExp)) +
    geom_line() +
    ggtitle("Chinese life expectancy") +
    theme_gray(base_size = 20) #<<
```

---

# Text and Tick Adjustments

Text size, labels, tick marks, etc. can be messed with more precisely using arguments to the `theme()` layer. 

Examples:

* `plot.title = element_text(size = rel(2), hjust = 0)` makes the title twice as big as usual and left-aligns it
* `axis.text.x = element_text(angle = 45)` rotates $x$ axis labels
* `axis.text = element_text(colour = "blue")` makes the $x$ and $y$ axis labels blue
* `axis.ticks.length = unit(.5, "cm")` makes the axis ticks longer

Note: `theme()` is a different layer than `theme_gray()` or `theme_bw()`, which you might also be using in a previous layer. See the [`ggplot2` documentation](http://docs.ggplot2.org/current/theme.html) for details. 

I recommend using `theme()` *after* `theme_bw()` or other *global themes*.

---

# Scales for Color, Shape, etc.

**Scales** are layers that control how the mapped aesthetics appear. You can modify these with a `scale_[aesthetic]_[option]()` layer where `[aesthetic]` is `color`, `shape`, `linetype`, `alpha`, `size`, `fill`, etc. and `[option]` is something like `manual`, `continuous` or `discrete` (depending on nature of the variable).

Examples:
* `scale_linetype_manual()`: manually specify the linetype for each different value
* `scale_alpha_continuous()`: varies transparency over a continuous range
* `scale_color_brewer(palette = "Spectral")`: uses a palette from <http://colorbrewer2.org> (great site for picking nice plot colors!)

When confused... Google or StackOverflow it!

---

## Legend Name and Manual Colors
.small[
```{r, fig.height=4, dev='svg'}
lifeExp_by_year +
  theme(legend.position = c(0.8, 0.25)) +
  scale_color_manual(
    name = "Which\ncontinent\nare we\nlooking at?", # \n adds a line break #<<
    values = c("Africa" = "seagreen", "Americas" = "turquoise1", 
               "Asia" = "royalblue", "Europe" = "violetred1", "Oceania" = "yellow"))
```
]
---

## Fussy Manual Legend Example Code
.small[
```{r, eval=FALSE}
ggplot(data = gapminder, aes(x = year, y = lifeExp, group = country)) +
    geom_line(alpha = 0.5, aes(color = "Country", size = "Country")) +
    geom_line(stat = "smooth", method = "loess", #<<
          aes(group = continent, color = "Continent", size = "Continent"), alpha = 0.5) +
    facet_wrap(~ continent, nrow = 2) + #<<
    scale_color_manual(name = "Life Exp. for:", #<<
                       values = c("Country" = "black", "Continent" = "blue")) + #<<
    scale_size_manual(name = "Life Exp. for:", 
                      values = c("Country" = 0.25, "Continent" = 3)) +
    theme_minimal(base_size = 14) + 
    ylab("Years") + xlab("") + 
    ggtitle("Life Expectancy, 1952-2007", subtitle = "By continent and country") +
    theme(legend.position=c(0.75, 0.2), axis.text.x = element_text(angle = 45)) #<<
```
]

Wow, there's a lot going on here!
* Two different `geom_line()` calls
   + One of them draws a [*loess* curve](https://en.wikipedia.org/wiki/Local_regression)
* `facet_wrap()` to make a plot for each level of `continent`
* Manual scales for size and color
* Custom labels, titles, and rotated x axis text

---
## 1. Base Plot
.smaller[
```{r, echo=TRUE, fig.height=3.5, dev='svg', fig.show="hold", warning=FALSE}
ggplot(data = gapminder, aes(x = year, y = lifeExp, group = country)) #<<
  #
  #
  #  
  #
  #
  #
  #
  #
  #
```
]

---


## 2. Lines

.smaller[
```{r, echo=TRUE, fig.height=3.5, dev='svg', fig.show="hold", warning=FALSE}
ggplot(data = gapminder, aes(x = year, y = lifeExp, group = country)) +
  geom_line() #<<
  #
  #  
  #
  #
  #
  #
  #
  #
```
]
---


## 3. Continent Average

.smaller[
```{r, echo=TRUE, fig.height=3.5, dev='svg', fig.show="hold", warning=FALSE}
ggplot(data = gapminder, aes(x = year, y = lifeExp, group = country)) +
  geom_line() +
  geom_line(stat = "smooth", method = "loess", #<<
            aes(group = continent)) #<<
  #
  #
  #
  #
  #
  #
```
]
---


## 4. Facets

.smaller[
```{r, echo=TRUE, fig.height=3.5, dev='svg', fig.show="hold", warning=FALSE}
ggplot(data = gapminder, aes(x = year, y = lifeExp, group = country)) +
  geom_line() +
  geom_line(stat = "smooth", method = "loess", 
            aes(group = continent)) +
  facet_wrap(~ continent, nrow = 2) #<<
  #
  #
  #
  #
  #
```
]
---


## 5. Color Scale

.smaller[
```{r, echo=TRUE, fig.height=3.5, dev='svg', fig.show="hold", warning=FALSE}
ggplot(data = gapminder, aes(x = year, y = lifeExp, group = country)) +
  geom_line(aes(color = "Country")) + #<<
  geom_line(stat = "smooth", method = "loess", 
            aes(group = continent, color = "Continent")) + #<<
  facet_wrap(~ continent, nrow = 2) +
  scale_color_manual(name = "Life Exp. for:", values = c("Country" = "black", "Continent" = "blue")) #<<
  #
  #
  #
  #
```
]
---


## 6. Size Scale
.smaller[
```{r, echo=TRUE, fig.height=3.5, dev='svg', fig.show="hold", warning=FALSE}
ggplot(data = gapminder, aes(x = year, y = lifeExp, group = country)) +
  geom_line(aes(color = "Country", size = "Country")) + #<<
  geom_line(stat = "smooth", method = "loess", 
            aes(group = continent, color = "Continent", size = "Continent")) + #<<
  facet_wrap(~ continent, nrow = 2) +
  scale_color_manual(name = "Life Exp. for:", values = c("Country" = "black", "Continent" = "blue")) +
  scale_size_manual(name = "Life Exp. for:", values = c("Country" = 0.25, "Continent" = 3)) #<<
  #
  #
  #
```
]
---


## 7. Alpha (Transparency)

.smaller[
```{r, echo=TRUE, fig.height=3.5, dev='svg', fig.show="hold", warning=FALSE}
ggplot(data = gapminder, aes(x = year, y = lifeExp, group = country)) +
  geom_line(alpha = 0.5, aes(color = "Country", size = "Country")) + #<<
  geom_line(stat = "smooth", method = "loess", 
            aes(group = continent, color = "Continent", size = "Continent"), alpha = 0.5) + #<<
  facet_wrap(~ continent, nrow = 2) +
  scale_color_manual(name = "Life Exp. for:", values = c("Country" = "black", "Continent" = "blue")) +
  scale_size_manual(name = "Life Exp. for:", values = c("Country" = 0.25, "Continent" = 3))
  #
  #
  #
```
]

---


## 8. Theme and Labels

.smaller[
```{r, echo=TRUE, fig.height=3.5, dev='svg', fig.show="hold", warning=FALSE}
ggplot(data = gapminder, aes(x = year, y = lifeExp, group = country)) +
  geom_line(alpha = 0.5, aes(color = "Country", size = "Country")) +
  geom_line(stat = "smooth", method = "loess", 
            aes(group = continent, color = "Continent", size = "Continent"), alpha = 0.5) +
  facet_wrap(~ continent, nrow = 2) +
  scale_color_manual(name = "Life Exp. for:", values = c("Country" = "black", "Continent" = "blue")) +
  scale_size_manual(name = "Life Exp. for:", values = c("Country" = 0.25, "Continent" = 3)) +
  theme_minimal(base_size = 14) + ylab("Years") + xlab("") #<<
  #
  #
```
]
---


## 9. Title and Subtitle

.smaller[
```{r, echo=TRUE, fig.height=3.5, dev='svg', fig.show="hold", warning=FALSE}
ggplot(data = gapminder, aes(x = year, y = lifeExp, group = country)) +
  geom_line(alpha = 0.5, aes(color = "Country", size = "Country")) +
  geom_line(stat = "smooth", method = "loess", 
            aes(group = continent, color = "Continent", size = "Continent"), alpha = 0.5) +
  facet_wrap(~ continent, nrow = 2) +
  scale_color_manual(name = "Life Exp. for:", values = c("Country" = "black", "Continent" = "blue")) +
  scale_size_manual(name = "Life Exp. for:", values = c("Country" = 0.25, "Continent" = 3)) +
  theme_minimal(base_size = 14) + ylab("Years") + xlab("") + 
  ggtitle("Life Expectancy, 1952-2007", subtitle = "By continent and country") #<<
  #
```
]
---


## 10. Angled Tick Values

.smaller[
```{r, echo=TRUE, fig.height=3.5, dev='svg', fig.show="hold", warning=FALSE}
ggplot(data = gapminder, aes(x = year, y = lifeExp, group = country)) +
  geom_line(alpha = 0.5, aes(color = "Country", size = "Country")) +
  geom_line(stat = "smooth", method = "loess", 
            aes(group = continent, color = "Continent", size = "Continent"), alpha = 0.5) +
  facet_wrap(~ continent, nrow = 2) +
  scale_color_manual(name = "Life Exp. for:", values = c("Country" = "black", "Continent" = "blue")) +
  scale_size_manual(name = "Life Exp. for:", values = c("Country" = 0.25, "Continent" = 3)) +
  theme_minimal(base_size = 14) + ylab("Years") + xlab("") + 
  ggtitle("Life Expectancy, 1952-2007", subtitle = "By continent and country") +
  theme(axis.text.x = element_text(angle = 45)) #<<
```
]

.footnote[Note: Fewer values might be better than angled labels!]
---


## 11. Legend Position

.smaller[
```{r, echo=TRUE, fig.height=3.5, dev='svg', fig.show="hold", warning=FALSE}
ggplot(data = gapminder, aes(x = year, y = lifeExp, group = country)) +
  geom_line(alpha = 0.5, aes(color = "Country", size = "Country")) +
  geom_line(stat = "smooth", method = "loess", 
            aes(group = continent, color = "Continent", size = "Continent"), alpha = 0.5) +
  facet_wrap(~ continent, nrow = 2) +
  scale_color_manual(name = "Life Exp. for:", values = c("Country" = "black", "Continent" = "blue")) +
  scale_size_manual(name = "Life Exp. for:", values = c("Country" = 0.25, "Continent" = 3)) +
  theme_minimal(base_size = 14) + ylab("Years") + xlab("") + 
  ggtitle("Life Expectancy, 1952-2007", subtitle = "By continent and country") +
  theme(legend.position=c(0.82, 0.15), axis.text.x = element_text(angle = 45)) #<<
```
]
---

## Fussy Manual Legend

```{r, echo=FALSE, fig.height=3.5, dev='svg'}
ggplot(data = gapminder, aes(x = year, y = lifeExp, group = country)) +
    geom_line(alpha = 0.5, aes(color = "Country", size = "Country")) +
    geom_line(stat = "smooth", method = "loess", aes(group = continent, color = "Continent", size = "Continent"), alpha = 0.5) +
    facet_wrap(~ continent, nrow = 2) +
    scale_color_manual(name = "Life Exp. for:", values = c("Country" = "black", "Continent" = "blue")) +
    scale_size_manual(name = "Life Exp. for:", values = c("Country" = 0.25, "Continent" = 3)) +
    theme_minimal(base_size = 14) + ylab("Years") + xlab("") + ggtitle("Life Expectancy, 1952-2007", subtitle = "By continent and country") +
    theme(legend.position=c(0.82, 0.15), axis.text.x = element_text(angle = 45))
```

Observation: One could use `filter()` to identify the countries with dips in life expectancy and investigate.

Know Your History: What happened in Africa in the early 1990s and Asia in the mid-1970s that might reduce life expectancy suddenly *for one country*?

---

## More on Customizing Legends

You can move the legends around, flip their orientation, remove them altogether, etc. The [Cookbook for R website](http://www.cookbook-r.com/Graphs/Legends_%28ggplot2%29) is a good resource for questions such as changing legend labels.

---

# Saving `ggplot` Plots

When you knit an R Markdown file, any plots you make are automatically saved in the "figure" folder in `.png` format. If you want to save another copy (perhaps of a different file type for use in a manuscript), use `ggsave()`:

```{r, eval=FALSE}
ggsave("I_saved_a_file.pdf", plot = lifeExp_by_year,
       height = 3, width = 5, units = "in")
```

If you didn't manually set font sizes, these will usually come out at a reasonable size given the dimensions of your output file.

**Bad/non-reproducible way**<sup>1</sup>: choose *Export* on the plot preview or take a screenshot / snip.

.footnote[[1] I still do this for quick emails of simple plots. Bad me!]

---
# Bonus Plot

`ggplot2` is well suited to making complex, publication ready plots.

This is the complete syntax for one plot from a recent article of mine.<sup>1</sup>

.small[
```{r, eval=FALSE}
ggplot(estimated_pes, aes(x = Target, y = PE, group = Reporter)) + 
  facet_grid(`Crime Type` ~ Neighborhood) +
  geom_errorbar(aes(ymin = LB, ymax = UB),
                position = position_dodge(width = .4), size = 0.75, width = 0.15) +
  geom_point(shape = 21, position = position_dodge(width = .4),
             size = 2, aes(fill = Reporter)) + 
  scale_fill_manual("Reporter",
                    values = c("Any White" = "white", "All Black" = "black")) +
  ggtitle("Figure 3. Probability of Arrest", 
          subtitle = "by Reporter and Target Race, Neighborhood and Crime Type") +
  xlab("Race of Target") + ylab("Estimated Probability") + 
  theme_bw() + theme(legend.position = c(0.86, 0.15),
                     legend.background = element_rect(color = 1))
```
]

.footnote[
[1] [Lanfear, Charles C., Lindsey R. Beach, Timothy A. Thomas. 2018. "Formal Social Control in Changing Neighborhoods: Racial Implications of Neighborhood Context on Reactive Policing." *City & Community* 17(4):1075-1099](https://onlinelibrary.wiley.com/doi/10.1111/cico.12346)
]
---

.center[
<img src="https://raw.githubusercontent.com/clanfear/CSSS508/master/Lectures/Week2/img/arrest_pe_plot.png" style="width: 80%;"/>
]
.footnote[We'll build this plot in the lecture on model results!]

---
class: inverse

# Book Recommendation

.pull-left[
![](img/dv-cover-pupress.jpg)
]
.pull-right[
* Targeted at Social Scientists without technical backgrounds

* Teaches good visualization principles

* Uses R, `ggplot2`, and `tidyverse`

* [Free online version!](https://socviz.co/)

* Affordable in print
]

---

# Tinkering Suggestions

Experiment with making some graphs in `ggplot2` of the Gapminder data. You can look at a subset of the data using `filter()` to limit rows, plot different $x$ and $y$ variables, facet by a factor, etc.

Some other options:

* `geom_histogram()`, `geom_density()`, `geom_boxplot()` (see the [Cookbook for R site](http://www.cookbook-r.com/Graphs/Plotting_distributions_%28ggplot2%29/) for a reference)

* `geom_smooth()` for adding loess or regression lines (see the [`ggplot2` documentation](http://docs.ggplot2.org/current/geom_smooth.html))

* Install [Jeff Arnold's `ggthemes` package](https://github.com/jrnold/ggthemes), load it, and try `theme_economist()`, `theme_stata()`, `theme_excel()` instead of no theme or `theme_bw()`

---
class: inverse

# Homework

Pick some relationship to look at in the Gapminder data and write up a .Rmd file investigating that question graphically. You might work with a subset of the data (e.g. just Africa). Upload both the `.Rmd` file and the `.html` file to Canvas. 

* Include 4 to 8 plots.
* All titles, axes, and legends should be labelled clearly (no raw variable names).
* You must have at least one graph with `facet_wrap()` or `facet_grid()`.
* You must include at least one manually specified legend.
* You can use other `geoms` like histograms, bar charts, add vertical or horizontal lines, etc. [You may find this data visualization cheat sheet helpful](https://www.rstudio.com/wp-content/uploads/2016/11/ggplot2-cheatsheet-2.1.pdf).

Your document should be pleasant for a peer to look at, with some organization. You must write up your observations in words as well as showing the graphs. Use chunk options like `echo=FALSE` to limit the code/output you show in the `.html`.